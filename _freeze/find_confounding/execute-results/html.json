{
  "hash": "5fa08d818bd299d69719bfda2bcdf3fe",
  "result": {
    "markdown": "---\ntitle: \"Identifying Confounders\"\nformat:\n  html:\n    code-fold: true\n    code-summary: 'Show The Code'\n---\n\n\nOne of the many subtasks when performing a prediction scheme is adjusting for mediating and confounding variables. But what is a mediator, what is a confounder, and why include thhem? Counfounder and Mediators can be illustrated using a causal diagram (From [this Wikipedia page](https://en.wikipedia.org/wiki/Confounding)):\n\n![](https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Comparison_confounder_mediator.svg/2560px-Comparison_confounder_mediator.svg.png)\n\nAs you can see, a confounding variable is something that confounds or 'confuses' the relationship between an exposure and an outcome. The relationship between an exposure X and an outcome Y is influenced by a confounding variable Z. A mediating variable connects an exposure to an outcome where otherwise would not be. The relationship between an exposure X and an outcome Y is influenced by a mediating variable Z.\n\nHere, I will show how MCCV can be used to identify confounders and mediators.\n\n::: {.panel-tabset}\n\n# Confounding\n\n**Generate dataset with an effect X, outcome Y, and a confounder Z variables**\n\nThe random variable Z generates X and Y. Any correlation between X and Y is therefore spurious\n\n\n::: {.cell hash='find_confounding_cache/html/unnamed-chunk-1_a773f7e11c01be88d50282cc8b3bcbfa'}\n\n```{.python .cell-code}\n\nimport numpy as np\nN=100\nZ1 = np.random.normal(loc=0,scale=1,size=N)\nZ2 = np.random.normal(loc=1,scale=1,size=N)\nZ = np.concatenate([Z1,Z2])\n\nimport scipy as sc\nY = np.concatenate([sc.stats.bernoulli.rvs(z,size=1) for z in (Z - min(Z)) / (max(Z) - min(Z))])\nX = Z + np.random.normal(loc=0,scale=1,size=len(Z))\n```\n:::\n\n::: {.cell hash='find_confounding_cache/html/unnamed-chunk-2_1b9830ae30f3c4756b2ba15e37be4b99'}\n\n```{.r .cell-code}\ndf <- tibble::tibble(\n    X = reticulate::py$X,\n    Y = reticulate::py$Y,\n    Z = reticulate::py$Z\n)\ndf[['Y']] <- factor(df$Y,levels=c(0,1))\n\ndf\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 200 × 3\n           X Y             Z\n   <dbl[1d]> <fct> <dbl[1d]>\n 1   -0.861  0       -0.0394\n 2   -0.0157 0       -0.649 \n 3    0.857  0        0.626 \n 4    1.78   0        1.84  \n 5   -1.33   0       -0.539 \n 6    0.688  0       -1.40  \n 7   -0.132  0        0.949 \n 8    0.636  0       -0.702 \n 9    1.43   0        0.606 \n10   -0.276  0       -0.319 \n# … with 190 more rows\n```\n:::\n\n```{.r .cell-code}\nGGally::ggpairs(df)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nRegistered S3 method overwritten by 'GGally':\n  method from   \n  +.gg   ggplot2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](find_confounding_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n**Employ MCCV: Predict Y from X, Y from Z, Y from X and Z**\n\n\n::: {.cell hash='find_confounding_cache/html/unnamed-chunk-3_4c60b9cb36082004fc756baad733468c'}\n\n```{.python .cell-code}\nimport pandas as pd\ndf = pd.DataFrame(data={'X' : X,'Y' : Y,'Z' : Z})\ndf.index.name = 'pt'\n\nX = df.loc[:,['X']]\nY = df.loc[:,['Y']]\nZ = df.loc[:,['Z']]\nXZ = df.loc[:,['X','Z']]\n```\n:::\n\n::: {.cell hash='find_confounding_cache/html/unnamed-chunk-4_0659138b6bb8b9ba15bc8bd5101d4a08'}\n\n```{.python .cell-code}\nimport mccv\n\nmccv_YXobj = mccv.mccv(num_bootstraps=200,n_jobs=2)\nmccv_YXobj.set_X(X)\nmccv_YXobj.set_Y(Y)\nmccv_YXobj.run_mccv()\n\nmccv_YZobj = mccv.mccv(num_bootstraps=200,n_jobs=2)\nmccv_YZobj.set_X(Z)\nmccv_YZobj.set_Y(Y)\nmccv_YZobj.run_mccv()\n\nmccv_YXZobj = mccv.mccv(num_bootstraps=200,n_jobs=2)\nmccv_YXZobj.set_X(XZ)\nmccv_YXZobj.set_Y(Y)\nmccv_YXZobj.run_mccv()\n```\n:::\n\n::: {.cell hash='find_confounding_cache/html/unnamed-chunk-5_4067550cde23ebf04f675df8d686d352'}\n\n```{.python .cell-code}\n\nf_imp_dfs = dict()\nf_imp_dfs['YXobj'] = \\\nmccv_YXobj.mccv_data['Feature Importance']\nf_imp_dfs['YZobj'] = \\\nmccv_YZobj.mccv_data['Feature Importance']\nf_imp_dfs['YXZobj'] = \\\nmccv_YXZobj.mccv_data['Feature Importance']\n```\n:::\n\n\n**Visualize feature importances**\n\n\n::: {.cell hash='find_confounding_cache/html/unnamed-chunk-6_a9c2e79efb04264fe09ad48713ae1033'}\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\nf_imp_plot <- function(x,title){\n    ggplot(x,aes(feature,importance,color=feature)) +\n    geom_boxplot(alpha=0) +\n    geom_point(position=position_jitter(width=0.2)) +\n    scale_color_manual(values=c(\"X\" = \"indianred\",\n                                \"Y\" = \"skyblue\",\n                                \"Z\" = \"black\",\n                                \"Intercept\" = \"gray\")) +\n    theme_bw() +\n    labs(title=title)\n}\n\nlibrary(patchwork)\n(f_imp_plot( reticulate::py$f_imp_dfs$YXobj,\"Y ~ X\" ) +\n    f_imp_plot( reticulate::py$f_imp_dfs$YZobj,\"Y ~ Z\" ) ) /\n    f_imp_plot( reticulate::py$f_imp_dfs$YXZobj,\"Y ~ X + Z\" )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n```\n:::\n\n::: {.cell-output-display}\n![](find_confounding_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nIn this example, Z is confounding the relationship between X and Y. The 'Y \\~ X' model shows that X is very important in predicting Y. However, when Z is included in the model 'Y \\~ X + Z', you see that Z remains very important but X is no longer important for predicting Y. This toy example had Z causing Y and Z causing X, and any relationship between X and Y was spurious. Therefore, including X and Z as predictors showed only the importance of Z in predicting Y.\n\n# Mediation\n\n**Generate dataset with an effect X, outcome Y, and a mediator Z variables**\n\nThe random variable X generates Z which generates and Y. Any correlation between X and Y is therefore spurious\n\n\n::: {.cell hash='find_confounding_cache/html/unnamed-chunk-7_04f05105dde95a6a6f918510cdcf0f71'}\n\n```{.python .cell-code}\n\nimport numpy as np\nN=100\nX1 = np.random.normal(loc=0,scale=1,size=N)\nX2 = np.random.normal(loc=1,scale=1,size=N)\nX = np.concatenate([X1,X2])\n\nimport scipy as sc\nZ = X + np.random.normal(loc=0,scale=1,size=len(X))\nY = np.concatenate([sc.stats.bernoulli.rvs(z,size=1) for z in (Z - min(Z)) / (max(Z) - min(Z))])\n```\n:::\n\n::: {.cell hash='find_confounding_cache/html/unnamed-chunk-8_176002b7fbca8f6efb754e084d37ed21'}\n\n```{.r .cell-code}\ndf <- tibble::tibble(\n    X = reticulate::py$X,\n    Y = reticulate::py$Y,\n    Z = reticulate::py$Z\n)\ndf[['Y']] <- factor(df$Y,levels=c(0,1))\n\ndf\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 200 × 3\n           X Y             Z\n   <dbl[1d]> <fct> <dbl[1d]>\n 1    -0.566 1        -1.13 \n 2     0.728 0         0.519\n 3     0.456 0        -0.657\n 4    -0.833 0        -0.908\n 5    -0.199 1         0.225\n 6    -0.241 0        -2.03 \n 7     0.322 0        -0.649\n 8    -2.55  0        -2.90 \n 9     0.350 0        -1.17 \n10     0.563 0        -0.117\n# … with 190 more rows\n```\n:::\n\n```{.r .cell-code}\nGGally::ggpairs(df)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nRegistered S3 method overwritten by 'GGally':\n  method from   \n  +.gg   ggplot2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](find_confounding_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n**Employ MCCV: Predict Y from X, Y from Z, Y from X and Z**\n\n\n::: {.cell hash='find_confounding_cache/html/unnamed-chunk-9_63bd85066ee0d40b66696707368488d4'}\n\n```{.python .cell-code}\nimport pandas as pd\ndf = pd.DataFrame(data={'X' : X,'Y' : Y,'Z' : Z})\ndf.index.name = 'pt'\n\nX = df.loc[:,['X']]\nY = df.loc[:,['Y']]\nZ = df.loc[:,['Z']]\nXZ = df.loc[:,['X','Z']]\n```\n:::\n\n::: {.cell hash='find_confounding_cache/html/unnamed-chunk-10_b012c6f14886b39e30df2d4fabbf509b'}\n\n```{.python .cell-code}\nimport mccv\n\nmccv_YXobj = mccv.mccv(num_bootstraps=200,n_jobs=2)\nmccv_YXobj.set_X(X)\nmccv_YXobj.set_Y(Y)\nmccv_YXobj.run_mccv()\n\nmccv_YZobj = mccv.mccv(num_bootstraps=200,n_jobs=2)\nmccv_YZobj.set_X(Z)\nmccv_YZobj.set_Y(Y)\nmccv_YZobj.run_mccv()\n\nmccv_YXZobj = mccv.mccv(num_bootstraps=200,n_jobs=2)\nmccv_YXZobj.set_X(XZ)\nmccv_YXZobj.set_Y(Y)\nmccv_YXZobj.run_mccv()\n```\n:::\n\n::: {.cell hash='find_confounding_cache/html/unnamed-chunk-11_4e5ca198c22a079fc88cceabb5c973de'}\n\n```{.python .cell-code}\n\nf_imp_dfs = dict()\nf_imp_dfs['YXobj'] = \\\nmccv_YXobj.mccv_data['Feature Importance']\nf_imp_dfs['YZobj'] = \\\nmccv_YZobj.mccv_data['Feature Importance']\nf_imp_dfs['YXZobj'] = \\\nmccv_YXZobj.mccv_data['Feature Importance']\n```\n:::\n\n\n**Visualize feature importances**\n\n\n::: {.cell hash='find_confounding_cache/html/unnamed-chunk-12_1b30563ef6bb83ba62009797799bf5c2'}\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\nf_imp_plot <- function(x,title){\n    ggplot(x,aes(feature,importance,color=feature)) +\n    geom_boxplot(alpha=0) +\n    geom_point(position=position_jitter(width=0.2)) +\n    scale_color_manual(values=c(\"X\" = \"indianred\",\n                                \"Y\" = \"skyblue\",\n                                \"Z\" = \"black\",\n                                \"Intercept\" = \"gray\")) +\n    theme_bw() +\n    labs(title=title)\n}\n\nlibrary(patchwork)\n(f_imp_plot( reticulate::py$f_imp_dfs$YXobj,\"Y ~ X\" ) +\n    f_imp_plot( reticulate::py$f_imp_dfs$YZobj,\"Y ~ Z\" ) ) /\n    f_imp_plot( reticulate::py$f_imp_dfs$YXZobj,\"Y ~ X + Z\" )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n\nWarning in py_to_r.pandas.core.frame.DataFrame(object): index contains\nduplicated values: row names not set\n```\n:::\n\n::: {.cell-output-display}\n![](find_confounding_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\nIn this example, Z is a mediating relationship between X and Y. The 'Y \\~ X' model shows that X is very important in predicting Y. However, when Z is included in the model 'Y \\~ X + Z', you see that Z remains very important but X is no longer important for predicting Y. This toy example had Z causing Y and X relating to Y through Z, and any relationship between X and Y was mediated through Z. Therefore, including X and Z as predictors showed only the importance of Z in predicting Y.\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}